<%- include("static/header.ejs"); %>
<div class="px-10 mt-5 pt-5">
    <p class="has-text-white title is-large"><i class="fad fa-edit has-text-success"></i> Edit your Bot.</p>
    <p class="content has-text-white" style="margin-top: -20px;">Do you want to make changes to your bot? You can edit the fields you want.</p>
    <div class="hr mb-5"></div>

    <article class="message is-danger" id="errors" style="display:none;">
        <div class="message-body">
          <h3><b><i class="fa fa-exclamation-circle" aria-hidden="true"></i> You should fix the following problems!</b></h3>
          <div id="errorDetails"></div>
        </div>
    </article>
    <article class="message is-success" id="trueMessage" style="display:none;">
        <div class="message-body">
          <h3><b><i class="fa fa-check-circle" aria-hidden="true"></i> Great!</b></h3>
          You have successfully edited your bot page on our website. Please wait, you are redirecting...
        </div>
    </article>
    <div class="columns is-multiline">
        <div class="mb-3 column is-4">
            <div>
                <b class="has-text-white"><i class="fad fa-fingerprint"></i> Bot ID <span class="has-text-danger">*</span></b>
                <p class="has-text-white" style="opacity: 0.6;">Enter your bot client ID.</p>
            </div>
            <input type="text" id="id" disabled value="<%= data.id %>" class="mt-3 form-input">
        </div>
        <div class="mb-3 column is-4">
            <div>
                <b class="has-text-white"><i class="fad fa-terminal"></i> Prefix <span class="has-text-danger">*</span></b>
                <p class="has-text-white" style="opacity: 0.6;">Enter your bot prefix.</p>
            </div>
            <input type="text" id="prefix" class="mt-3 form-input" value="<%= data.prefix %>" placeholder="Prefix (Example: !)">
        </div>
        <div class="mb-3 column is-4">
            <div>
                <b class="has-text-white"><i class="fad fa-tags"></i> Tags <span class="has-text-danger">*</span></b>
                <p class="has-text-white" style="opacity: 0.6;">Select tags of your bots.</p>
            </div>
            <div id="tags" class="form-input mt-3" style="position:relative;">
            <select class="-mb-5 tagsSelect">
                <option value="Moderation">Moderation</option>
                <option value="Music">Music</option>
                <option value="Game">Game</option>
                <option value="Utility">Utility</option>
                <option value="Economy">Economy</option>
                <option value="NSFW">NSFW</option>
                <option value="Fun">Fun</option>
                <option value="Meme">Meme</option>
                <option value="Turkish">Turkish</option>
                <option value="Invite">Invite Systems</option>
                <option value="Autorole">Autorole</option>
                <option value="Minecraft">Minecraft</option>
                <option value="Fortnite">Fortnite</option>
                <option value="Emojis">Emojis</option>
            </select>
                <input type="hidden" id="tagss" value="<%= data.tags %>"/>
            </div>
        </div>
        
        <div class="mb-3 column is-4">
            <div>
                <b class="has-text-white"><i class="fad fa-link"></i> Invite Link</b>
                <p class="has-text-white" style="opacity: 0.6;">Invite link of your bot. Please don't use 8 permission!</p>
            </div>
            <input type="text" id="inviteLink" value="<%= data.inviteLink %>" class="mt-3 form-input" placeholder="Invite Link">
        </div>

        <div class="mb-3 column is-4">
            <div>
                <b class="has-text-white"><i class="fad fa-user-crown"></i> CO-Owners</b>
                <p class="has-text-white" style="opacity: 0.6;">Other owners of your bot.</p>
            </div>
            <input type="text" id="owners" value="<%= data.owners %>" class="mt-3 form-input" placeholder="Other owners of your bot. (Example: 1234556789,123456789)">
        </div>
        
        <div class="mb-3 column is-4">
            <div>
                <b class="has-text-white"><i class="fad fa-globe"></i> Website</b>
                <p class="has-text-white" style="opacity: 0.6;">Personal Website url of your bot.</p>
            </div>
            <input type="text" id="website" value="<%= data.website %>" class="mt-3 form-input" placeholder="Personal Website url of your bot.">
        </div>

        <div class="mb-3 column is-4">
            <div>
                <b class="has-text-white"><i class="fab fa-discord"></i> Support Server</b>
                <p class="has-text-white" style="opacity: 0.6;">Support Server of your bot.</p>
            </div>
            <input type="text" id="supportServer" value="<%= data.supportServer %>" class="mt-3 form-input" placeholder="Support Server. (Example: https://discord.gg/abcdefg)">
        </div>

        <div class="column is-8">
            <div>
                <b class="has-text-white"><i class="fa fa-comment"></i> Short Description <span class="has-text-danger">*</span></b>
                <p class="has-text-white" style="opacity: 0.6;">Short description of your bot.</p>
            </div>
            <input type="text" id="shortDescription" value="<%= data.shortDescription %>" class="mt-3 form-input" placeholder="Bla bla bla... (Min 30 characters, Max: 200 characters)">
        </div>

        <div class="column is-12">
            <div>
                <b class="has-text-white"><i class="fa fa-comment"></i> Detailed Description <span class="has-text-danger">*</span></b>
                <p class="has-text-white" style="opacity: 0.6;">Detailed description of your bot. (Markdown Allowed)</p>
            </div>
            <br>
            <textarea id="detailedDescription" class="mt-3 form-input" rows="8"></textarea>
        </div>

    </div>

    <br>

    <button class="button is-success mr-2 is-medium" type="button" id="edit"><i class="fad fa-user-edit"></i>&nbsp;Edit</button>
    <button class="button is-dark is-medium preview" onclick="preview();" type="button"><i class="fad fa-eye"></i>&nbsp;Preview</button>
    
    <div id="modal" class="modal previewModal">
        <div class="modal-background"></div>
            <div class="modal-content" style="top:50%; bottom: 50%; transform: translateY(-50%); width: 85%; height: 85%; overflow: hidden;">
                <iframe id="previewFrame" style="width: 100%; height: 100%;" src="" frameborder="0"></iframe>
            </div>
            <button class="modal-close is-large" aria-label="close"></button>
        </div>
    </div>

</div>

<script>
    $(".modal-close").click(function (e) { 
        $(".previewModal").fadeOut(500);   
    });
    function preview() {
        $(".preview").addClass("is-loading");
        $.ajax({
            type: "POST",
            url: "/api/bot/<%= data.id %>/preview",
            data: {id:$("#id").val(), prefix: $("#prefix").val(), tags: $("#tagss").val(), inviteLink: $("#inviteLink").val(), owners: $("#owners").val(), website: $("#website").val(), supportServer: $("#supportServer").val(), shortDescription: $("#shortDescription").val(), detailedDescription: editor.getValue()},
            success: function (response) {
            }
        });
        setTimeout(() => {
            $(".previewModal").fadeIn(500);
            $("#previewFrame").attr("src","/bot/<%= data.id %>/preview");
            $(".preview").removeClass("is-loading");
        }, 1000);
    }

    var editor = CodeMirror.fromTextArea($('#detailedDescription')[0], {
        mode: 'markdown',
        htmlMode: true,
        lineNumbers: true,
        theme: 'ayu-mirage'
    });
    
    $.ajax({
        type: "POST",
        url: "/bot/<%= data.id %>/description",
        data: {post: "OK"},
        success: function (response) {
            editor.setValue(response);
            editor.setSize(null,"400px")
        }
    });
    
    $("#edit").click(function (e) {
        var data = {id:$("#id").val(), prefix: $("#prefix").val(), tags: $("#tagss").val(), inviteLink: $("#inviteLink").val(), owners: $("#owners").val(), website: $("#website").val(), supportServer: $("#supportServer").val(), shortDescription: $("#shortDescription").val(), detailedDescription: editor.getValue()}
        $.ajax({
            type: "POST",
            url: "/bots/edit/<%= data.id %>",
            data: data,
            dataType: "json",
            success: function (response) {
                if (response.isError == true) {
                    var message = "";
                    Object.values(response).forEach(data => {
                        if (data != true) {
                            message += "Â» " + data + "<br>";  
                        }
                    });  
                    $("#trueMessage").hide();
                    $("html, body").animate({ scrollTop: 0 }, "slow");
                    $("#errors").show();
                    $("#errorDetails").html(message);
                } else {
                    $("#errors").hide();
                    $("#errorDetails").html("");
                    $("#trueMessage").show();
                    $("html, body").animate({ scrollTop: 0 }, "slow");
                    setTimeout(() => {
                        window.location.href = "/bot/" + $("#id").val();
                    }, 2500);
                }
            }
        });        
    });
</script>
<%- include("static/footer.ejs"); %>